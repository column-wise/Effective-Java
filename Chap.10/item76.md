# item 76. 가능한 한 실패 원자적으로 만들라

호출된 메서드가 실패하더라도 해당 객체는 메서드 호출 전 상태를 유지해야 한다.

이러한 특성을 실패 원자적(failure-atomic)이라고 한다.

메서드를 실패 원자적으로 만드는 방법

1. 불변 객체로 설계한다.

    메서드가 실패했을 때 객체 생성이 되지 않을 수는 있겠으나(생성자 실패),
    기존 객체의 상태가 수정되어 불안정한 상태에 빠지는 일은 발생하지 않는다.

2. 가변 객체의 경우 메서드 수행에 앞서 매개 변수의 유효성을 검사

3. 실패할 가능성이 있는 모든 코드를 객체의 상태를 바꾸는 코드보다 앞에 배치하는 방법

    ex. TreeMap을 보면, 원소를 추가하기에 앞서, 원소가 들어갈 위치를 먼저 찾는다.  
    엉뚱한 타입의 원소를 추가하려 하면, 원소 위치를 찾는 과정에서 `ClassCastException`을 던진다.

4. 임시 복사본에서 작업을 수행한 다음, 작업이 성공하면 원래 객체와 교체한다.

    데이터를 임시 자료구조에 저장해 작업하는 것이 더 빠를 때 적용하기 좋음.

5. 작업 도줄 발생하는 실패를 가로채는 복구 코드를 작성하여 작업 전 상태로 롤백

    디스크 기반의 durability를 보장해야 하는 자료구조에 쓰이는데, 자주 쓰이는 방법은 아니다.

---

실패 원자성을 보장하도록 객체를 설계하는 것이 권장되지만, 항상 보장해야 하는 것은 아님.

* 두 쓰레드가 동기화 없이 같은 객체를 수정하면 일관성이 깨진다.  `ConcurrentModificationException`를 잡아냈다고 해서 여전히 쓸 수 있는 상태라고 생각해서는 안됨.

* Error 발생시에는 복구할 수 없으므로 실패 원자적으로 만들려는 시도 자체가 불필요함.

* 실패 원자적으로 만들 수 있더라도 달성하기 위한 비용이나 복잡도가 너무 큰 경우